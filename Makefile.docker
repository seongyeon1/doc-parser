# ğŸ³ Document Parser Project - Docker Makefile
# Docker í™˜ê²½ì—ì„œ ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” Makefile

.PHONY: help docker-build docker-start docker-stop docker-clean docker-logs docker-shell docker-test

# ê¸°ë³¸ ì„¤ì •
COMPOSE_FILE = docker-compose.yml
PROJECT_NAME = doc-parser

# ë„ì›€ë§
help:
	@echo "ğŸ³ Document Parser Project - Docker Makefile ë„ì›€ë§"
	@echo "================================================"
	@echo ""
	@echo "ğŸ”§ Docker ëª…ë ¹ì–´:"
	@echo "  make docker-build    - Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make docker-start    - Docker ì»¨í…Œì´ë„ˆ ì‹œì‘"
	@echo "  make docker-stop     - Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€"
	@echo "  make docker-restart  - Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
	@echo "  make docker-clean    - Docker ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì •ë¦¬"
	@echo "  make docker-logs     - Docker ë¡œê·¸ í™•ì¸"
	@echo "  make docker-shell    - Docker ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†"
	@echo "  make docker-status   - Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
	@echo "  make docker-test     - Docker í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make docker-update   - Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸"
	@echo ""

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker-build:
	@echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) build
	@echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"

# Docker ì»¨í…Œì´ë„ˆ ì‹œì‘
docker-start:
	@echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) up -d
	@echo "âœ… Docker ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ğŸ“Š API ì„œë²„: http://0.0.0.0:8000 (ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥)"
	@echo "ğŸŒ ì‹œê°í™” ë„êµ¬: http://0.0.0.0:8080/visualize_results.html (ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥)"
	@echo "ğŸŒ í†µí•© ì ‘ì†: http://0.0.0.0 (Nginx, ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥)"
	@echo ""
	@echo "ğŸ’¡ ì™¸ë¶€ ì ‘ê·¼:"
	@echo "  - API ì„œë²„: http://[ì„œë²„IP]:8000"
	@echo "  - ì‹œê°í™” ë„êµ¬: http://[ì„œë²„IP]:8080/visualize_results.html"
	@echo "  - í†µí•© ì ‘ì†: http://[ì„œë²„IP]"

# Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€
docker-stop:
	@echo "ğŸ›‘ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) down
	@echo "âœ… Docker ì»¨í…Œì´ë„ˆê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."

# Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker-restart:
	@echo "ğŸ”„ Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) restart
	@echo "âœ… Docker ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."

# Docker ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì •ë¦¬
docker-clean:
	@echo "ğŸ§¹ Docker ì •ë¦¬ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) down -v --rmi all
	docker system prune -f
	@echo "âœ… Docker ì •ë¦¬ ì™„ë£Œ!"

# Docker ë¡œê·¸ í™•ì¸
docker-logs:
	@echo "ğŸ“‹ Docker ë¡œê·¸ í™•ì¸ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) logs -f

# íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
docker-logs-api:
	@echo "ğŸ“‹ API ì„œë²„ ë¡œê·¸ í™•ì¸ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) logs -f api-server

docker-logs-viz:
	@echo "ğŸ“‹ ì‹œê°í™” ì„œë²„ ë¡œê·¸ í™•ì¸ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) logs -f viz-server

# Docker ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
docker-shell:
	@echo "ğŸš Docker ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì† ì¤‘..."
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤:"
	@echo "  make docker-shell-api    - API ì„œë²„ ì‰˜ ì ‘ì†"
	@echo "  make docker-shell-viz    - ì‹œê°í™” ì„œë²„ ì‰˜ ì ‘ì†"
	@echo "  make docker-shell-nginx  - Nginx ì‰˜ ì ‘ì†"

docker-shell-api:
	@echo "ğŸš API ì„œë²„ ì‰˜ ì ‘ì† ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) exec api-server /bin/bash

docker-shell-viz:
	@echo "ğŸš ì‹œê°í™” ì„œë²„ ì‰˜ ì ‘ì† ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) exec viz-server /bin/bash

docker-shell-nginx:
	@echo "ğŸš Nginx ì‰˜ ì ‘ì† ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) exec nginx /bin/sh

# Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker-status:
	@echo "ğŸ“Š Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) ps
	@echo ""
	@echo "ğŸ” ìƒì„¸ ìƒíƒœ:"
	docker stats --no-stream

# Docker í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
docker-test:
	@echo "ğŸ§ª Docker í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) exec api-server python -m pytest test_*.py -v
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) exec viz-server python test_processor.py
	@echo "âœ… Docker í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
docker-update:
	@echo "ğŸ”„ Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) pull
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) build --no-cache
	@echo "âœ… Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"

# ê°œë°œ ëª¨ë“œ (ë³¼ë¥¨ ë§ˆìš´íŠ¸)
docker-dev:
	@echo "ğŸ”§ ê°œë°œ ëª¨ë“œë¡œ Docker ì‹œì‘ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) -f docker-compose.dev.yml up -d
	@echo "âœ… ê°œë°œ ëª¨ë“œ Dockerê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"

# í”„ë¡œë•ì…˜ ëª¨ë“œ
docker-prod:
	@echo "ğŸš€ í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ Docker ì‹œì‘ ì¤‘..."
	docker-compose -f $(COMPOSE_FILE) -p $(PROJECT_NAME) -f docker-compose.prod.yml up -d
	@echo "âœ… í”„ë¡œë•ì…˜ ëª¨ë“œ Dockerê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"

# ë°±ì—… ë° ë³µì›
docker-backup:
	@echo "ğŸ’¾ Docker ë°ì´í„° ë°±ì—… ì¤‘..."
	@mkdir -p backups
	docker run --rm -v $(PROJECT_NAME)_data-volume:/data -v $(PWD)/backups:/backup alpine tar czf /backup/data_backup_$(shell date +%Y%m%d_%H%M%S).tar.gz /data
	@echo "âœ… ë°±ì—… ì™„ë£Œ: backups/ í´ë” í™•ì¸"

# ë¹ ë¥¸ ì‹œì‘ (ë¹Œë“œ + ì‹œì‘)
docker-quick-start: docker-build docker-start
	@echo ""
	@echo "ğŸ‰ Docker ë¹ ë¥¸ ì‹œì‘ ì™„ë£Œ!"
	@echo "ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:8080/visualize_results.html ì—´ê¸°"
